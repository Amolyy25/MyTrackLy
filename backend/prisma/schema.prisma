generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String               @id @default(uuid())
  email                String               @unique
  passwordHash         String               @map("password_hash")
  role                 String               @default("personnel") @map("role") // "personnel" | "eleve" | "coach"
  name                 String
  goalType             String?              @map("goal_type")
  coachId              String?              @map("coach_id") // Pour les élèves, ID du coach
  coach                User?                @relation("CoachStudents", fields: [coachId], references: [id], onDelete: SetNull)
  students             User[]               @relation("CoachStudents") // Pour les coaches, liste des élèves
  createdAt            DateTime             @default(now()) @map("created_at")
  updatedAt            DateTime             @updatedAt @map("updated_at")

  // Relations existantes
  trainingSessions     TrainingSession[]
  customExercises      Exercise[]
  measurements         Measurement[]
  habits               Habit[]              // Habitudes de l'utilisateur
  invitationCodes      InvitationCode[]     // Codes d'invitation créés par le coach
  usedInvitationCodes  InvitationCode[]     @relation("UsedInvitationCodes") // Codes utilisés par l'élève
  passwordResetTokens  PasswordResetToken[] // Tokens de reset de mot de passe

  // Intégration Google Calendar (pour les coaches)
  googleCalendarAccessToken  String?  @map("google_calendar_access_token")
  googleCalendarRefreshToken String?  @map("google_calendar_refresh_token")
  googleCalendarExpiry       DateTime? @map("google_calendar_expiry")
  googleCalendarId           String?  @map("google_calendar_id") // ID du calendrier utilisé (primary ou dédié)
  
  // Configuration Coach
  slotDuration               Int      @default(60) @map("slot_duration") // Durée des créneaux en minutes
  myTrackLyCalendarId        String?  @map("mytrackly_calendar_id") // ID du calendrier dédié "Séances MyTrackLy"

  // Réservations (en tant que coach / élève)
  coachReservations   Reservation[] @relation("CoachReservations")
  studentReservations Reservation[] @relation("StudentReservations")
  availabilities      CoachAvailability[]

  @@map("users")
}

model InvitationCode {
  id            String    @id @default(uuid())
  code          String    @unique // Code unique et complexe
  coachId       String    @map("coach_id")
  coach         User      @relation(fields: [coachId], references: [id], onDelete: Cascade)
  used          Boolean   @default(false) // Si le code a été utilisé
  usedByUserId  String?   @map("used_by_user_id") // ID de l'élève qui a utilisé le code
  usedBy        User?     @relation("UsedInvitationCodes", fields: [usedByUserId], references: [id], onDelete: SetNull)
  expiresAt     DateTime? @map("expires_at") // Date d'expiration (optionnelle)
  createdAt     DateTime  @default(now()) @map("created_at")
  usedAt        DateTime? @map("used_at") // Date d'utilisation

  @@map("invitation_codes")
  @@index([coachId])
  @@index([code])
}

model TrainingSession {
  id              String            @id @default(uuid())
  userId          String            @map("user_id")
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  date            DateTime
  durationMinutes Int?              @map("duration_minutes")
  notes           String?
  coachComment    String?           @map("coach_comment") // Commentaire du coach sur la séance
  exercises       SessionExercise[]
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  @@map("training_sessions")
  @@index([userId, date])
}
model Exercise {
  id            String            @id @default(uuid())
  name          String
  category      String            // 'strength', 'cardio', 'flexibility', 'other'
  muscleGroups  Json?             @map("muscle_groups") // ['chest', 'triceps']
  defaultUnit   String            @map("default_unit") // 'reps', 'time', 'distance', 'weight'
  isCustom      Boolean           @default(false) @map("is_custom")
  createdByUserId String?         @map("created_by_user_id")
  createdBy     User?             @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)
  sessions      SessionExercise[]
  createdAt     DateTime          @default(now()) @map("created_at")

  @@map("exercises")
}

model SessionExercise {
  id            String          @id @default(uuid())
  sessionId     String          @map("session_id")
  session       TrainingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  exerciseId    String          @map("exercise_id")
  exercise      Exercise        @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  sets          Int
  repsPerSet    Json?           @map("reps_per_set") // [7, 7, 5, 5, 4]
  repsUniform   Int?            @map("reps_uniform") // 8 (si toutes les séries sont identiques)
  weightKg      Float?          @map("weight_kg")
  durationSeconds Int?          @map("duration_seconds")
  restSeconds   Int?            @map("rest_seconds")
  orderIndex    Int             @map("order_index")
  notes         String?
  createdAt     DateTime        @default(now()) @map("created_at")

  @@map("session_exercises")
  @@index([sessionId])
}

model Measurement {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  date          DateTime
  bodyWeightKg  Float?   @map("body_weight_kg")
  leftArmCm     Float?   @map("left_arm_cm")
  rightArmCm    Float?   @map("right_arm_cm")
  leftCalfCm    Float?   @map("left_calf_cm")
  rightCalfCm   Float?   @map("right_calf_cm")
  chestCm       Float?   @map("chest_cm")
  waistCm       Float?   @map("waist_cm")
  hipsCm        Float?   @map("hips_cm")
  leftThighCm   Float?   @map("left_thigh_cm")
  rightThighCm  Float?   @map("right_thigh_cm")
  neckCm        Float?   @map("neck_cm")
  shouldersCm  Float?   @map("shoulders_cm")
  notes         String?
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("measurements")
  @@unique([userId, date])
  @@index([userId, date])
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique // Token unique pour le reset
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("password_reset_tokens")
  @@index([userId])
}

// Réservations de séances (liées au calendrier du coach)
model Reservation {
  id          String   @id @default(uuid())

  // Coach qui reçoit la réservation
  coachId     String   @map("coach_id")
  coach       User     @relation("CoachReservations", fields: [coachId], references: [id], onDelete: Cascade)

  // Élève qui réserve la séance
  studentId   String   @map("student_id")
  student     User     @relation("StudentReservations", fields: [studentId], references: [id], onDelete: Cascade)

  startDateTime DateTime @map("start_datetime")
  endDateTime   DateTime @map("end_datetime")

  // Type de séance : muscu, yoga, cardio, autre...
  sessionType String    @map("session_type")
  notes       String?

  status      String    @default("pending") // "pending" | "confirmed" | "cancelled" | "refused"

  // Lien avec Google Calendar
  googleEventId String? @map("google_event_id")

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("reservations")
  @@index([coachId])
  @@index([studentId])
  @@index([startDateTime, endDateTime])
}

model CoachAvailability {
  id        String   @id @default(uuid())
  coachId   String   @map("coach_id")
  coach     User     @relation(fields: [coachId], references: [id], onDelete: Cascade)

  // Jour de la semaine (0 = Dimanche, 1 = Lundi, ..., 6 = Samedi)
  dayOfWeek Int      @map("day_of_week")

  // Heure de début (format HH:mm, ex: "09:00")
  startTime String   @map("start_time")

  // Heure de fin (format HH:mm, ex: "12:00")
  endTime   String   @map("end_time")

  // Si le créneau est actif ou non (pour désactiver temporairement sans supprimer)
  isActive  Boolean  @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("coach_availabilities")
  @@index([coachId])
}

enum Frequency {
  DAILY
  WEEKLY
  MONTHLY
}

model Habit {
  id                String     @id @default(uuid())
  userId            String     @map("user_id")
  user              User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  name              String
  category          String     // 'hydration' | 'sleep' | 'nutrition' | 'exercise' | 'wellness'
  targetFrequency   Frequency  @default(DAILY) @map("target_frequency") // 'DAILY' | 'WEEKLY' | 'MONTHLY'
  targetCount       Float?     @map("target_count") // Quantité optionnelle (ex: 1.5L)
  currentStreak     Int        @default(0) @map("current_streak")
  longestStreak     Int        @default(0) @map("longest_streak")
  lastLogDate       DateTime?  @map("last_log_date")
  reminderTime      String?    @map("reminder_time") // Format HH:mm (ex: "19:00")
  reminderEnabled   Boolean    @default(true) @map("reminder_enabled")
  startDate         DateTime   @default(now()) @map("start_date")
  logs              HabitLog[]
  createdAt         DateTime   @default(now()) @map("created_at")
  updatedAt         DateTime   @updatedAt @map("updated_at")

  @@map("habits")
  @@index([userId])
  @@index([userId, startDate])
}

model HabitLog {
  id            String   @id @default(uuid())
  habitId       String   @map("habit_id")
  habit         Habit    @relation(fields: [habitId], references: [id], onDelete: Cascade)
  completedAt   DateTime @map("completed_at") // Date/heure de complétion
  value         Float?   // Valeur si quantifiable (litres, heures, etc.)
  createdAt     DateTime @default(now()) @map("created_at")

  @@map("habit_logs")
  @@unique([habitId, completedAt])
  @@index([habitId, completedAt])
  @@index([completedAt])
}